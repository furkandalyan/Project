{% extends "eys/base.html" %}

{% block content %}
<div style="background:white; border-radius:20px; padding:30px; box-shadow:0 25px 60px rgba(0,0,0,0.08); margin-bottom:25px;">
    <p style="margin:0; color:#9a9a9a; text-transform:uppercase; letter-spacing:0.08em; font-size:12px;">Sınav Not Girişi</p>
    <h1 style="margin:6px 0 0 0;">{{ exam.course.code }} • {{ exam.name }}</h1>
    <p style="color:#666;">Bu dersin tüm öğrencileri için skor ve geri bildirim girebilirsin. Boş bıraktığın satırlar silinir.</p>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:stretch;">

        <div style="display:flex; align-items:center; gap:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:10px 12px; min-height:88px;">
            {% if qr_data_url %}
                <img src="{{ qr_data_url }}" alt="QR" style="width:88px; height:88px; border-radius:8px;">
            {% else %}
                <div style="width:88px; height:88px; border-radius:8px; background:#e2e8f0; display:flex; align-items:center; justify-content:center; color:#64748b; font-size:12px;">QR yok</div>
            {% endif %}
            <div style="display:flex; flex-direction:column; gap:6px;">
                <strong style="font-size:13px;">Mobil Not Girisi</strong>
                <span style="font-size:12px; color:#64748b;">Telefonla bu QR kodu okut.</span>
                <a href="{{ mobile_url }}" style="font-size:12px; color:#1db954; text-decoration:none;">Mobil ekrani ac</a>
            </div>
        </div>
        
        <a href="{% url 'export_exam_scores_csv' exam.id %}"
           style="display:flex; align-items:center; justify-content:center; padding:10px 14px; min-height:88px; border:1px solid #e2e8f0; border-radius:12px; text-decoration:none; color:#1f2937; background:#f8fafc; font-weight:600;">CSV Disari Aktar</a>
        <form method="POST" enctype="multipart/form-data" style="display:flex; gap:8px; align-items:center; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:10px 12px; min-height:88px;">
            {% csrf_token %}
            <input type="file" name="csv_file" accept="text/csv" style="border:1px solid #e2e8f0; border-radius:10px; padding:6px; background:#fff;">
            <button type="submit" style="padding:8px 12px; border:none; border-radius:10px; background:#1f1f1f; color:white; font-weight:600;">CSV Ice Aktar</button>
        </form>

    </div>
</div>

<form method="POST" style="background:white; border-radius:20px; padding:24px; box-shadow:0 20px 50px rgba(0,0,0,0.08); display:flex; flex-direction:column; gap:18px;">
    {% csrf_token %}
    <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#f8f8f8;">
                    <th style="text-align:left; padding:12px;">Öğrenci</th>
                    <th style="text-align:left; padding:12px;">Skor (0-100)</th>
                    <th style="text-align:left; padding:12px;">Geri Bildirim</th>
                </tr>
            </thead>
            <tbody>
                {% for row in student_rows %}
                {% with student=row.student result=row.result %}
                <tr style="border-bottom:1px solid #f0f0f0;">
                    <td style="padding:12px;">
                        <strong>{{ student.get_full_name|default:student.username }}</strong>
                        <span style="display:block; color:#888; font-size:13px;">{{ student.email|default:"E-posta yok" }}</span>
                    </td>
                    <td style="padding:12px;">
                        <input type="number" step="0.01" min="0" max="100" name="score_{{ student.id }}" value="{% if result %}{{ result.score }}{% endif %}"
                               style="width:120px; padding:10px; border-radius:10px; border:1px solid #ddd;">
                    </td>
                    <td style="padding:12px;">
                        <textarea name="feedback_{{ student.id }}" rows="2" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">{% if result %}{{ result.feedback }}{% endif %}</textarea>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr><td colspan="3" style="padding:20px; text-align:center; color:#999;">Bu derse kayıtlı öğrenci bulunmuyor.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:12px;">
        <a href="{% url 'exam_detail' exam.id %}"
           style="padding:12px 20px; border-radius:12px; border:1px solid #ccc; text-decoration:none; color:#333;">İptal</a>
        <button type="submit"
                style="padding:12px 24px; border:none; border-radius:12px; background:#1db954; color:white; font-weight:600;">
            Notları Kaydet
        </button>
    </div>
</form>
<script>
(function(){
    const inputs = Array.from(document.querySelectorAll('input[name^="score_"]'));
    const form = document.querySelector('form[method="POST"]');
    inputs.forEach((inp, idx) => {
        inp.addEventListener('keydown', function(e){
            if (e.key === 'Enter' && !e.ctrlKey) {
                e.preventDefault();
                const next = inputs[idx+1];
                if (next) next.focus();
                return;
            }
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (form) form.submit();
                return;
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const next = inputs[idx+1];
                if (next) next.focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prev = inputs[idx-1];
                if (prev) prev.focus();
            }
        });
        inp.addEventListener('focus', function(){
            try { localStorage.setItem('lastScoreInput', inp.name); } catch(e) {}
        });
    });
    try {
        const last = localStorage.getItem('lastScoreInput');
        if (last) {
            const el = document.querySelector(`input[name="${last}"]`);
            if (el) el.focus();
        }
    } catch(e) {}
})();
</script>
{% endblock %}
