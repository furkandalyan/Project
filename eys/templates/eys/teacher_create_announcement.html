{% extends "eys/base.html" %}

{% block content %}
<div style="max-width:1100px; margin:0 auto;">
    <div style="display:flex; gap:24px; flex-wrap:wrap;">
        <div style="flex:1; min-width:320px;">
            <div style="background:white; padding:34px; border-radius:20px; box-shadow:0 28px 60px rgba(0,0,0,0.08);">
                <h2 style="margin-top:0;">Yeni Duyuru OluÅŸtur</h2>
                <p style="color:#6f6f6f; line-height:1.5;">
                    Ders seÃ§ersen sadece o dersi alan Ã¶ÄŸrenciler mesajÄ± gÃ¶rÃ¼r. Dersi boÅŸ bÄ±rakman durumunda duyuru bÃ¼tÃ¼n Ã¶ÄŸrencilere gider.
                </p>
                <div style="padding:14px 18px; background:#f0fbf4; border-radius:14px; color:#1c7b47; font-size:13px; margin-bottom:20px;">
                    Ders alanÄ±nÄ± boÅŸ bÄ±rakÄ±rsan <strong>genel duyuru</strong> olarak paylaÅŸÄ±lÄ±r. Bir ders seÃ§ersen sadece o derse kayÄ±tlÄ± Ã¶ÄŸrenciler gÃ¶rÃ¼r.
                </div>

                <form method="POST" style="display:flex; flex-direction:column; gap:20px;">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div style="background:#fff2f2; border:1px solid #ffbcbc; color:#c20000; padding:12px; border-radius:10px;">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <label for="{{ form.title.id_for_label }}" style="font-weight:600; color:#333;">BaÅŸlÄ±k</label>
                        {{ form.title }}
                        {% for error in form.title.errors %}
                            <span style="color:#d00000; font-size:13px;">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <label for="{{ form.body.id_for_label }}" style="font-weight:600; color:#333;">Mesaj</label>
                        {{ form.body }}
                        {% for error in form.body.errors %}
                            <span style="color:#d00000; font-size:13px;">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <label for="{{ form.course.id_for_label }}" style="font-weight:600; color:#333;">Ä°lgili Ders (opsiyonel)</label>
                        {{ form.course }}
                        <span style="color:#8a8a8a; font-size:13px;">BoÅŸ bÄ±rakÄ±lÄ±rsa duyuru tÃ¼m Ã¶ÄŸrencilere gider.</span>
                        {% for error in form.course.errors %}
                            <span style="color:#d00000; font-size:13px;">{{ error }}</span>
                        {% endfor %}
                    </div>

                    <div style="display:flex; align-items:center; gap:10px;">
                        {{ form.pinned }}
                        <label for="{{ form.pinned.id_for_label }}" style="font-weight:600; color:#333;">Sabit Duyuru</label>
                    </div>

                    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                        <span style="color:#666; font-size:13px;">HÄ±zlÄ± ÅŸablonlar:</span>
                        <button type="button" id="tpl-homework"
                                style="padding:8px 12px; border:1px solid #e0e0e0; background:white; border-radius:8px; cursor:pointer;">Ã–dev hatÄ±rlatma</button>
                        <button type="button" id="tpl-exam"
                                style="padding:8px 12px; border:1px solid #e0e0e0; background:white; border-radius:8px; cursor:pointer;">SÄ±nav duyurusu</button>
                        <button type="button" id="tpl-general"
                                style="padding:8px 12px; border:1px solid #e0e0e0; background:white; border-radius:8px; cursor:pointer;">Genel bilgi</button>
                    </div>

                    <button type="submit"
                            style="padding:14px 0; border:none; border-radius:12px; background:linear-gradient(120deg,#1db954,#1aa34a); color:white; font-weight:600; font-size:16px; cursor:pointer; box-shadow:0 15px 25px rgba(29,185,84,0.25);">
                        Duyuruyu YayÄ±nla
                    </button>
                </form>
            </div>
        </div>

        <div style="flex:0.9; min-width:280px;">
            <div style="background:#1f1f1f; color:white; border-radius:20px; padding:30px; box-shadow:0 30px 60px rgba(0,0,0,0.35); position:sticky; top:20px;">
                <p style="margin:0; text-transform:uppercase; letter-spacing:0.1em; font-size:12px; color:#bbbbbb;">CanlÄ± Ã–nizleme</p>
                <h3 id="preview-title" style="margin:6px 0 12px 0;">BaÅŸlÄ±k bekleniyor</h3>
                <p id="preview-body" style="color:#d7d7d7; line-height:1.6; white-space:pre-line;">Mesaj metni burada belirecek.</p>
                <div style="margin:20px 0; padding:18px; border-radius:12px; background:#2b2b2b;">
                    <p style="margin:0; font-size:13px; color:#9fe5bc;">GÃ¶nderen</p>
                    <strong style="display:block; margin-top:4px;">{{ request.user.get_full_name|default:request.user.username }}</strong>
                    <p id="preview-meta" style="margin:6px 0 0 0; color:#b5b5b5; font-size:13px;">Genel Duyuru â€¢ Ã–nizleme</p>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:46px; height:46px; border-radius:14px; background:#27ae60; display:flex; align-items:center; justify-content:center; font-size:20px;">ðŸ“£</div>
                    <div>
                        <p style="margin:0; font-size:13px; color:#bfbfbf;">Duyuru tipi</p>
                        <strong id="preview-course" style="font-size:15px;">Genel duyuru</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const titleInput = document.getElementById("{{ form.title.id_for_label }}");
    const bodyInput = document.getElementById("{{ form.body.id_for_label }}");
    const courseSelect = document.getElementById("{{ form.course.id_for_label }}");
    const previewTitle = document.getElementById("preview-title");
    const previewBody = document.getElementById("preview-body");
    const previewCourse = document.getElementById("preview-course");
    const previewMeta = document.getElementById("preview-meta");
    const authorName = "{{ request.user.get_full_name|default:request.user.username|escapejs }}";
    let lastAutoTitle = "";

    function labelForCourse() {
        const option = courseSelect.options[courseSelect.selectedIndex];
        return option && option.value ? option.text : "Genel duyuru";
    }

    function nowLabel() {
        const now = new Date();
        return now.toLocaleString("tr-TR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }

    function syncPreview() {
        const title = titleInput.value.trim();
        const body = bodyInput.value.trim();
        previewTitle.textContent = title || "BaÅŸlÄ±k bekleniyor";
        previewBody.textContent = body || "Mesaj metni burada belirecek. Yazmaya baÅŸladÄ±ÄŸÄ±nda Ã¶nizleme otomatik gÃ¼ncellenecek.";
        previewCourse.textContent = labelForCourse();
        previewMeta.textContent = `${labelForCourse()} â€¢ ${nowLabel()} â€¢ ${authorName}`;
    }

    [titleInput, bodyInput, courseSelect].forEach(function(el) {
        if (!el) return;
        el.addEventListener("input", syncPreview);
        el.addEventListener("change", syncPreview);
    });

    syncPreview();

    const tplHomework = document.getElementById("tpl-homework");
    const tplExam = document.getElementById("tpl-exam");
    const tplGeneral = document.getElementById("tpl-general");

    function applyTemplate(kind) {
        if (kind === "homework") {
            titleInput.value = "Ã–dev HatÄ±rlatma";
            bodyInput.value = "Merhaba,\n\nÄ°lgili Ã¶devin teslim tarihi yaklaÅŸmaktadÄ±r. LÃ¼tfen belirtilen tarihe kadar Ã¶devinizi sisteme yÃ¼kleyin. SorularÄ±nÄ±z iÃ§in bu iletiye yanÄ±t verebilirsiniz.";
        } else if (kind === "exam") {
            titleInput.value = "SÄ±nav Duyurusu";
            bodyInput.value = "DeÄŸerli Ã¶ÄŸrenciler,\n\nSÄ±nav tarihi ve saati duyurulmuÅŸtur. SÄ±nava gelirken kimlik kartÄ±nÄ±zÄ± getiriniz. BaÅŸarÄ±lar dilerim.";
        } else if (kind === "general") {
            titleInput.value = "Bilgilendirme";
            bodyInput.value = "Selamlar,\n\nDersle ilgili genel bilgilendirme yapÄ±lmÄ±ÅŸtÄ±r. Takvim ve materyaller gÃ¼nceldir. Ä°yi Ã§alÄ±ÅŸmalar.";
        }
        syncPreview();
    }

    if (tplHomework) tplHomework.addEventListener("click", function(){ applyTemplate("homework") });
    if (tplExam) tplExam.addEventListener("click", function(){ applyTemplate("exam") });
    if (tplGeneral) tplGeneral.addEventListener("click", function(){ applyTemplate("general") });

    if (courseSelect) {
        courseSelect.addEventListener("change", function() {
            const label = labelForCourse();
            const autoTitle = label && label !== "Genel duyuru" ? `${label} duyurusu` : "Bilgilendirme";
            if (!titleInput.value.trim() || titleInput.value.trim() === lastAutoTitle) {
                titleInput.value = autoTitle;
                lastAutoTitle = autoTitle;
                syncPreview();
            }
        });
    }
})();
</script>
{% endblock %}

