{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% trans "EYS - E?itim Y?netim Sistemi" %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Mode (Default) */
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --sidebar-width: 260px;
            --text-color: #1a1c23;
            --text-muted: #6b7280;
            --accent: #1db954;
            --accent-hover: #1ed760;
            --border-color: #e4e4e7;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.4);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            /* Badge Colors (Light) */
            --badge-bg: #f1f5f9;
            --badge-text: #0f172a;
        }

        /* Dark Mode Overrides */
        body.dark-mode {
            --bg-color: #121212;
            --sidebar-bg: #18181b;
            --text-color: #e4e4e7;
            --text-muted: #a1a1aa;
            --border-color: #27272a;
            --card-bg: #1e1e21; /* Koyu kart rengi */
            --input-bg: #27272a;
            --glass-bg: rgba(30, 30, 30, 0.8);
            --glass-border: rgba(255, 255, 255, 0.1);

            /* Badge Colors (Dark) */
            --badge-bg: #27272a;
            --badge-text: #e4e4e7;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Specific Overrides for Inline Styles */
        body.dark-mode div[style*="background:white"],
        body.dark-mode div[style*="background: white"],
        body.dark-mode .course-card,
        body.dark-mode .stat-card,
        body.dark-mode .section-card {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }


        body.dark-mode div[style*="background:#f8fafc"],
        body.dark-mode div[style*="background:#f8f8f8"],
        body.dark-mode div[style*="background:#f1f5f9"],
        body.dark-mode div[style*="background:#f7f7f7"],
        body.dark-mode div[style*="background:#f7f9fc"],
        body.dark-mode div[style*="background:#f9f9f9"],
        body.dark-mode div[style*="background:#fcfcfc"],
        body.dark-mode div[style*="background:#f0f0f0"],
        body.dark-mode div[style*="background:#eef0f4"],
        body.dark-mode div[style*="background:#f3fff6"] {
            background: #27272a !important; /* Daha koyu ic kutular */
            color: var(--text-color) !important;
        }


        body.dark-mode input,
        body.dark-mode select {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3, body.dark-mode h4, body.dark-mode strong {
            color: #ffffff !important;
        }

        body.dark-mode p, body.dark-mode span, body.dark-mode li {
            color: var(--text-muted);
        }

        /* Inline color overrides for dark mode */
        body.dark-mode [style*="color:#000"],
        body.dark-mode [style*="color:black"],
        body.dark-mode [style*="color:#111"],
        body.dark-mode [style*="color:#222"],
        body.dark-mode [style*="color:#333"],
        body.dark-mode [style*="color:#1f1f1f"],
        body.dark-mode [style*="color:#1a1c23"],
        body.dark-mode [style*="color:#0f172a"],
        body.dark-mode [style*="color:#444"],
        body.dark-mode [style*="color:#555"],
        body.dark-mode [style*="color:#666"],
        body.dark-mode [style*="color:#777"],
        body.dark-mode [style*="color:#888"],
        body.dark-mode [style*="color:#999"] {
            color: var(--text-color) !important;
        }

        body.dark-mode [style*="color:#6b7280"],
        body.dark-mode [style*="color:#7a7a7a"],
        body.dark-mode [style*="color:#8a8a8a"],
        body.dark-mode [style*="color:#94a3b8"],
        body.dark-mode [style*="color:#9a9a9a"] {
            color: var(--text-muted) !important;
        }

        /* Yeşil gradient kutuları koru ama borderlarını düzelt */
        body.dark-mode div[style*="linear-gradient"] {
            border: none !important;
            color: white !important;
        }
        body.dark-mode div[style*="linear-gradient"] p,
        body.dark-mode div[style*="linear-gradient"] h1 {
            color: white !important;
        }

        /* --- LOADING ANIMATION --- */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.4s ease;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            height: 100vh;
            position: sticky;
            top: 0;
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .brand {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .brand span {
            color: var(--accent);
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            margin-top: 20px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: var(--bg-color);
            color: var(--text-color);
        }

        .nav-link.active {
            background: rgba(29, 185, 84, 0.1); /* Emerald with opacity */
            color: var(--accent);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .user-profile {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            position: relative;
        }

        .avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* --- MAIN CONTENT --- */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: calc(100% - var(--sidebar-width));
            /* Prevent overflow */
        }

        .top-header {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            /* Glassmorphism Header */
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 40;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }

        .search-bar {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 99px;
            display: flex;
            align-items: center;
            flex: 1; /* Tüm boşluğu kapla */
            margin-right: 30px; /* Sağ taraftaki butonlara mesafe */
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }

        .search-bar:focus-within {
            box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
            border-color: var(--accent);
        }

        .search-bar input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 14px;
            margin-left: 8px;
            color: var(--text-color);
            background-color: transparent;
        }

        .content-container {
            padding: 30px 40px;
            flex: 1;
        }

        /* --- GLASSMORPHISM CARDS --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
            border-radius: 16px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Global kartların varsayılan görünümü için override */
        .card,
        div[style*="background:white"],
        div[style*="background: white"] {
            background: var(--card-bg) !important;
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color) !important;
            box-shadow: var(--shadow-md) !important;
            border-radius: 16px !important;
        }

        /* --- UTILS --- */
        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .badge {
            background: #ff4757;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            position: absolute;
            top: 0;
            right: 0;
        }

        /* Theme Toggle Button */
        .theme-toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theme-toggle-btn:hover {
            color: var(--text-color);
        }

        /* Toast Messages */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 16px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--accent);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* --- CEVAI Assistant --- */
        .cevai-fab {
            position: fixed;
            right: 24px;
            bottom: 24px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1db954, #119c45);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            letter-spacing: 0.04em;
            border: none;
            cursor: pointer;
            box-shadow: 0 12px 28px rgba(16, 185, 129, 0.35);
            z-index: 10001;
        }

        .cevai-panel {
            position: fixed;
            right: 24px;
            bottom: 96px;
            width: 480px;
            max-width: calc(100vw - 48px);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            z-index: 10001;
            display: none;
            overflow: hidden;
            opacity: 0;
            transform: translateY(16px) scale(0.98);
        }

        .cevai-panel.cevai-open {
            animation: cevaiPop 0.25s ease forwards;
        }

        @keyframes cevaiPop {
            from {
                opacity: 0;
                transform: translateY(16px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }


        .cevai-header {
            background: linear-gradient(135deg, #0f5132, #1db954);
            color: white;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cevai-header strong {
            font-size: 14px;
        }

        .cevai-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 520px;
            overflow: auto;
        }

        .cevai-msg {
            padding: 10px 12px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.4;
        }

        .cevai-msg.bot {
            background: #f8fafc;
            border: 1px solid var(--border-color);
        }

        .cevai-msg.user {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            align-self: flex-end;
        }

        .cevai-quick {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }


        .cevai-qa {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: #f8fafc;
        }

        .cevai-qa-question {
            font-size: 12px;
            font-weight: 600;
            color: #0f172a;
            text-align: left;
            background: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .cevai-qa-answer {
            font-size: 12px;
            color: #475569;
            line-height: 1.4;
        }

        .cevai-chip {
            background: #f1f5f9;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }


        .cevai-cats {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            background: #f8fafc;
        }

        .cevai-cat {
            background: #f1f5f9;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .cevai-cat.active {
            background: #1db954;
            color: white;
            border-color: #1db954;
        }

        .cevai-input {
            display: flex;
            gap: 8px;
            border-top: 1px solid var(--border-color);
            padding: 10px;
            background: #f8fafc;
        }

        .cevai-input input {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            background: white;
        }

        .cevai-input button {
            background: #1db954;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .cevai-panel {
                right: 12px;
                left: 12px;
                width: auto;
                bottom: 88px;
            }
            .cevai-fab {
                right: 16px;
                bottom: 16px;
                width: 64px;
                height: 64px;
            }
        }
    </style>
</head>

<body>

    {% block body_content %}
    <!-- LOADING SCREEN -->
    <div id="page-loader">
        <div class="loader-spinner"></div>
    </div>

    {% if not hide_navbar %}
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <a href="{% if user.is_authenticated and user.role %}{% if user.role.name == 'Student' %}{% url 'student_dashboard' %}{% elif user.role.name == 'Regular Instructor' or user.role.name == 'Advisor Instructor' or user.role.name == 'Head of Department' %}{% url 'teacher_dashboard' %}{% elif user.role.name == 'Student Affairs' %}{% url 'affairs_dashboard' %}{% else %}{% url 'home' %}{% endif %}{% else %}{% url 'home' %}{% endif %}" class="brand">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent);">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
            EYS
        </a>

        {% if user.is_authenticated %}
        <div class="user-profile">
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="avatar" onclick="document.getElementById('profile-picture-modal').style.display='flex'">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="{{ user.get_full_name|default:user.username }}">
                    {% else %}
                        {{ user.first_name|first|default:user.username|first|upper }}
                    {% endif %}
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600; font-size:14px;">{{ user.get_full_name|default:user.username }}</div>
                    <div style="font-size:12px; color:var(--text-muted);">{{ user.role.name }}</div>
                </div>
                <a href="/logout/" title="Çıkış" style="color:#ef4444; background:none; border:none; cursor:pointer;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </a>
            </div>

            <a href="{% url 'student_profile' %}" style="display:flex; align-items:center; gap:8px; margin-top:12px; color:var(--text-muted); text-decoration:none; font-size:13px; padding:8px 12px; background:var(--bg-color); border-radius:8px; transition:all 0.2s;" onmouseover="this.style.background='var(--border-color)'" onmouseout="this.style.background='var(--bg-color)'">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                {% trans "Profil Duzenle" %}
            </a>
        </div>
        {% endif %}

        <nav class="nav-links">
            {% if user.is_authenticated and user.role %}

            <!-- ÖĞRENCİ MENÜSÜ -->
            {% if user.role.name == 'Student' %}
            <a href="{% url 'student_dashboard' %}"
                class="nav-link {% if request.path == '/student/dashboard/' %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                {% trans "Dashboard" %}
            </a>
            <a href="{% url 'student_courses' %}" class="nav-link {% if '/student/course' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                {% trans "Derslerim" %}
            </a>
            <a href="{% url 'student_calendar' %}" class="nav-link {% if '/student/calendar/' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                {% trans "Takvim" %}
            </a>
            <a href="{% url 'student_assignments' %}" class="nav-link {% if '/student/assignment' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
                {% trans "Odevler" %}
            </a>
            <a href="{% url 'student_announcements' %}" class="nav-link {% if '/student/announcements/' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                {% trans "Duyurular" %}
            </a>

            <!-- ÖĞRETMEN & YÖNETİCİ MENÜSÜ -->
            {% elif user.role.name in 'Regular Instructor,Advisor Instructor,Head of Department' %}
            <a href="{% url 'teacher_dashboard' %}"
                class="nav-link {% if request.path == '/teacher/dashboard/' %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                {% trans "Dashboard" %}
            </a>
                        <a href="{% url 'teacher_courses' %}" class="nav-link {% if '/teacher/course' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                {% trans "Ders Yonetimi" %}
            </a>
            <a href="{% url 'teacher_assignments' %}" class="nav-link {% if '/teacher/assignment' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                {% trans "Odevler" %}
            </a>
                        <a href="{% url 'teacher_calendar' %}" class="nav-link {% if '/teacher/calendar/' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                {% trans "Takvim" %}
            </a>
            <a href="{% url 'teacher_announcements' %}" class="nav-link {% if '/teacher/announcement' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                {% trans "Duyurularim" %}
            </a>
            {% if user.role.name == 'Advisor Instructor' %}
            <a href="{% url 'advisor_students' %}" class="nav-link {% if '/advisor/students/' in request.path %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                {% trans "Danisman Ogrencilerim" %}
            </a>
            {% endif %}


            
            {% if user.role.name == 'Head of Department' %}
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--border-color);">
                <span
                    style="font-size:11px; color:var(--text-muted); padding-left:14px; text-transform:uppercase; letter-spacing:1px; font-weight:700;">{% trans "Yonetim" %}</span>
                
                <details style="margin-top:6px;">
                    <summary class="nav-link" style="color:var(--accent); list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between;">
                        <span style="display:flex; align-items:center; gap:12px;">
                            <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path>
                            </svg>
                            {% trans "Bolum Paneli" %}
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </summary>
                    <div style="margin-left:14px; display:flex; flex-direction:column; gap:6px; padding-top:6px;">
                        <a href="{% url 'department_overview' %}" class="nav-link {% if '/department/overview/' in request.path %}active{% endif %}">{% trans "Genel Bakis" %}</a>
                        <a href="{% url 'department_instructors' %}" class="nav-link {% if '/department/instructors/' in request.path %}active{% endif %}">{% trans "Ogretmenler" %}</a>
                        <a href="{% url 'department_courses' %}" class="nav-link {% if '/department/courses/' in request.path %}active{% endif %}">{% trans "Dersler" %}</a>
                    </div>
                </details>

            </div>
            {% endif %}


            <!-- ÖĞRENCİ İŞLERİ MENÜSÜ -->
            {% elif user.role.name == 'Student Affairs' %}
            <a href="{% url 'affairs_dashboard' %}" class="nav-link {% if request.path == '/affairs/dashboard/' %}active{% endif %}">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="2" x2="12" y2="6"></line>
                    <line x1="12" y1="18" x2="12" y2="22"></line>
                    <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                    <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                    <line x1="2" y1="12" x2="6" y2="12"></line>
                    <line x1="18" y1="12" x2="22" y2="12"></line>
                    <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                    <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
                </svg>
                {% trans "Genel Bakis" %}
            </a>
            <a href="{% url 'admin:eys_user_add' %}" class="nav-link" target="_blank">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Kullanıcı Ekle
            </a>
            <a href="{% url 'admin:eys_course_add' %}" class="nav-link" target="_blank">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                Ders Aç
            </a>
            {% endif %}

            {% else %}
            <a href="/" class="nav-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                {% trans "Ana Sayfa" %}
            </a>
            <a href="/login/" class="nav-link">
                <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                    <polyline points="10 17 15 12 10 7"></polyline>
                    <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
                Giriş Yap
            </a>
            {% endif %}
        </nav>
    </aside>
    {% endif %}

    <!-- MAIN CONTENT AREA -->
    <div class="main-wrapper">

        {% if not hide_navbar and user.is_authenticated %}
        <header class="top-header">
            <!-- Global Search -->
            <form class="search-bar" method="get" action="{% url 'global_search' %}">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" style="color:var(--text-muted);">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" name="q" placeholder="{% trans "Genel arama yap..." %}" value="{{ request.GET.q|default:'' }}">
            </form>

            <div style="display:flex; gap:20px; align-items:center;">
                <form action="{% url 'set_language' %}" method="post" style="display:flex; align-items:center; gap:8px;">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <label for="language-select" style="font-size:12px; color:var(--text-muted);">{% trans "Dil" %}</label>
                    <select id="language-select" name="language" onchange="this.form.submit()" style="padding:6px 8px; border-radius:8px; border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color);">
                        <option value="tr" {% if LANGUAGE_CODE == 'tr' %}selected{% endif %}>TR</option>
                        <option value="en" {% if LANGUAGE_CODE == 'en' %}selected{% endif %}>EN</option>
                    </select>
                </form>

                <!-- Dark Mode Toggle -->
                <button id="theme-toggle" class="theme-toggle-btn" title="Temayı Değiştir">
                    <!-- Sun Icon (for dark mode) -->
                    <svg id="sun-icon" style="display:none;" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <!-- Moon Icon (for light mode) -->
                    <svg id="moon-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>

                <a href="{{ nav_notification_target }}"
                    style="position:relative; text-decoration:none; color:var(--text-color); display: flex; align-items: center; margin-top: 4px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    {% if nav_notification_count > 0 %}
                    <span class="badge">{{ nav_notification_count }}</span>
                    {% endif %}
                </a>
            </div>
        </header>
        {% endif %}

        <main class="content-container">
            {% if messages %}
            <div id="toast-container">
                {% for message in messages %}
                <div class="toast">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}

            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- CEVAI Assistant -->
    <button id="cevai-fab" class="cevai-fab" aria-label="CEVAI">
        C
    </button>
    <div id="cevai-panel" class="cevai-panel" role="dialog" aria-label="CEVAI Assistant">
        <div class="cevai-header">
            <div>
                <strong>CEVAI</strong>
                <div style="font-size:11px; opacity:0.85;">Yardimci asistan</div>
            </div>
            <button id="cevai-close" style="background:transparent; border:none; color:white; font-size:18px; cursor:pointer;">&times;</button>
        </div>
        <div class="cevai-cats">
            <button class="cevai-cat active" data-cat="Hepsi">Hepsi</button>
            <button class="cevai-cat" data-cat="Genel">Genel</button>
            <button class="cevai-cat" data-cat="Ogrenci">Ogrenci</button>
            <button class="cevai-cat" data-cat="Ogretmen">Ogretmen</button>
            <button class="cevai-cat" data-cat="Notlar">Notlar</button>
            <button class="cevai-cat" data-cat="LO/PO">LO/PO</button>
            <button class="cevai-cat" data-cat="Odev">Odev</button>
            <button class="cevai-cat" data-cat="Duyuru">Duyuru</button>
            <button class="cevai-cat" data-cat="{% trans "Takvim" %}">{% trans "Takvim" %}</button>
            <button class="cevai-cat" data-cat="Profil">Profil</button>
            <button class="cevai-cat" data-cat="Bolum">Bolum</button>
        </div>
        <div id="cevai-body" class="cevai-body">
            <div class="cevai-msg bot">Merhaba! Ben CEVAI. Sana bu sistemde hizlica yardim edebilirim. Asagidaki orneklerden baslayabilirsin.</div>
            <div id="cevai-quick" class="cevai-quick"></div>
        </div>
        <div class="cevai-input">
            <input id="cevai-input" type="text" placeholder="Sorunu yaz..." />
            <button id="cevai-send">{% trans "Gonder" %}</button>
        </div>
    </div>

    <!-- Profile Picture Upload Modal -->
    {% if user.is_authenticated %}
    <div id="profile-picture-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:var(--card-bg); border-radius:20px; padding:32px; max-width:500px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h2 style="margin:0; font-size:24px; font-weight:700; color:var(--text-color);">Profil Fotoğrafı Değiştir</h2>
                <button onclick="document.getElementById('profile-picture-modal').style.display='none'" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-muted); padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:background 0.2s;" onmouseover="this.style.background='var(--bg-color)'" onmouseout="this.style.background='none'">&times;</button>
            </div>

            <form method="POST" action="{% url 'upload_profile_picture' %}" enctype="multipart/form-data" id="profile-picture-form">
                {% csrf_token %}
                <div style="text-align:center; margin-bottom:24px;">
                    <div style="width:120px; height:120px; margin:0 auto 16px; border-radius:50%; overflow:hidden; border:3px solid var(--border-color); position:relative;">
                        {% if user.profile_picture %}
                            <img id="profile-preview" src="{{ user.profile_picture.url }}" alt="Profile" style="width:100%; height:100%; object-fit:cover;">
                        {% else %}
                            <div id="profile-preview" style="width:100%; height:100%; background:linear-gradient(135deg, #FF6B6B, #4ECDC4); display:flex; align-items:center; justify-content:center; color:white; font-size:48px; font-weight:bold;">
                                {{ user.first_name|first|default:user.username|first|upper }}
                            </div>
                        {% endif %}
                    </div>
                    <label for="id_profile_picture" style="display:inline-block; padding:10px 20px; background:#1db954; color:white; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; transition:background 0.2s;" onmouseover="this.style.background='#1aa34a'" onmouseout="this.style.background='#1db954'">
                        Fotoğraf Seç
                    </label>
                    <input type="file" name="profile_picture" id="id_profile_picture" accept="image/*" style="display:none;" onchange="previewProfilePicture(this)" required>
                    <p style="margin:8px 0 0 0; font-size:12px; color:var(--text-muted);">JPG, PNG veya GIF (max 5MB)</p>
                </div>

                <div style="display:flex; gap:12px;">
                    <button type="submit" style="flex:1; padding:12px; background:#1db954; color:white; border:none; border-radius:10px; font-weight:600; cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='#1aa34a'" onmouseout="this.style.background='#1db954'">
                        Kaydet
                    </button>
                    <button type="button" onclick="document.getElementById('profile-picture-modal').style.display='none'" style="flex:1; padding:12px; background:var(--bg-color); color:var(--text-muted); border:none; border-radius:10px; font-weight:600; cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='var(--border-color)'" onmouseout="this.style.background='var(--bg-color)'">
                        İptal
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- SCRIPTS -->
    <script>
        // Theme Toggle Logic
        (function() {
            const toggleBtn = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const body = document.body;

            // Check local storage
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            function updateIcons(isDark) {
                if (isDark) {
                    sunIcon.style.display = 'block';
                    moonIcon.style.display = 'none';
                } else {
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'block';
                }
            }

            if (isDarkMode) {
                body.classList.add('dark-mode');
                updateIcons(true);
            } else {
                updateIcons(false);
            }

            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    body.classList.toggle('dark-mode');
                    const isDark = body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDark);
                    updateIcons(isDark);
                });
            }
        })();

        // Loading Animation Control
        window.addEventListener('load', function () {
            setTimeout(function () {
                var loader = document.getElementById('page-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(function () {
                        loader.style.display = 'none';
                    }, 400);
                }
            }, 500); // 0.5s suni gecikme (animasyonun tadı çıksın diye)
        });

        // Sayfa geçişlerinde loading göster
        document.querySelectorAll('a').forEach(function (link) {
            link.addEventListener('click', function (e) {
                if (link.hostname === window.location.hostname && !link.target && !link.href.includes('#')) {
                    var loader = document.getElementById('page-loader');
                    if (loader) {
                        loader.style.display = 'flex';
                        setTimeout(function () { loader.style.opacity = '1'; }, 10);
                    }
                }
            });
        });

        // Profile picture preview
        function previewProfilePicture(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var preview = document.getElementById('profile-preview');
                    preview.innerHTML = '<img src="' + e.target.result + '" alt="Preview" style="width:100%; height:100%; object-fit:cover;">';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Close modal when clicking outside
        document.getElementById('profile-picture-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    </script>

    <script>
        (function() {
            const fab = document.getElementById("cevai-fab");
            const panel = document.getElementById("cevai-panel");
            const closeBtn = document.getElementById("cevai-close");
            const body = document.getElementById("cevai-body");
            const input = document.getElementById("cevai-input");
            const send = document.getElementById("cevai-send");

            const roleName = "{{ user.role.name|default:'' }}";
            const currentPath = "{{ request.path|default:'' }}";
            let selectedCategory = "Hepsi";


            const quickMap = {
        "Hepsi": [
                "giris yapamiyorum",
                "sifre degistir",
                "tema degistir",
                "arama kutusu",
                "bildirimler",
                "derslerim nerede",
                "notlarim",
                "sinav tarihi",
                "odev teslim",
                "duyuru yaz",
                "takvim nerede",
                "lo nedir",
                "po nedir",
                "lo baglama",
                "po baglama",
                "csv disari aktar",
                "csv ice aktar",
                "ogrenci listesi",
                "danisman bilgisi",
                "profil guncelle",
                "materyal indir",
                "odev ek",
                "sinav ekle",
                "not girme",
                "geri bildirim",
                "bolum paneli",
                "ogretmen listesi",
                "ders listesi",
                "raporlar",
                "ics indir",
                "riskli ogrenci",
                "ortalama not",
                "not bantlari",
                "duyuru sil",
                "yorum ekle",
                "profil fotograf",
                "kullanici adi",
                "rol degisimi",
                "mobil not",
                "qr",
                "ogrenci paneli",
                "ogretmen paneli",
                "odev notla",
                "odev kriter",
                "dosya yukle",
                "sayfa acilmiyor",
                "yavas",
                "takvim gorunumu",
                "danisman ogrencilerim",
                "mesaj"
        ],
        "Genel": [
                "giris yapamiyorum",
                "sifre sifirla",
                "tema degistir",
                "arama kutusu",
                "bildirimler",
                "profil guncelle",
                "profil fotograf",
                "hesap bilgisi",
                "kullanici adi",
                "rol yetki",
                "sayfa acilmiyor",
                "yavas",
                "cikis",
                "yardim",
                "destek",
                "sistem nasil calisir",
                "guvenlik ipuclari",
                "parola kurallari",
                "tarayici uyum",
                "internet sorunu",
                "dosya yukle",
                "dosya indir",
                "hata mesaji",
                "duyuru bildirimi",
                "genel duyuru",
                "tema koyu mod",
                "tema acik mod",
                "arama nasil kullanilir",
                "bildirimleri temizle",
                "profil email",
                "kullanici ekle",
                "hesap sil",
                "kapatma",
                "yetki hatasi",
                "rol degisimi",
                "sayfa yenile",
                "guncelleme",
                "kisisel veri",
                "gizlilik",
                "cihaz degistir",
                "mobil uyum",
                "bildirim ayari",
                "oturum sure",
                "guvenli cikis",
                "tanimli rol",
                "yardimci asistan",
                "cevai",
                "cevai nasil calisir",
                "sik sorulan sorular",
                "iletisim"
        ],
        "Ogrenci": [
                "derslerim nerede",
                "notlarim",
                "sinav tarihi",
                "odev teslim",
                "odev teslim tarihi",
                "odev notu",
                "ders materyali",
                "takvim",
                "duyurular",
                "duyuru bildirimi",
                "danisman bilgisi",
                "profil guncelle",
                "profil fotograf",
                "email gorunur",
                "ogrenci paneli",
                "sinav sonucu",
                "lo puanim",
                "po puanim",
                "ders detayi",
                "ogrenci profil",
                "ogrenci listesi gorur muyum",
                "odev gec teslim",
                "odev ek dosya",
                "odev geri bildirim",
                "odev grup",
                "takvim haftalik",
                "takvim aylik",
                "bildirimler",
                "bildirim okundu",
                "duyuru yorum",
                "materyal indir",
                "materyal hafta",
                "sinav hatirlatma",
                "not bantlari",
                "ortalama not",
                "riskli ogrenci olur mu",
                "ders kaydi",
                "ders ekleme",
                "danisman hocam",
                "ogrenci haklari",
                "parola degistir",
                "sifre unutma",
                "cikis",
                "profil bilgileri",
                "yardim",
                "cevai yardim",
                "cevai ogrenci",
                "takvimde sinav",
                "kurs kodu",
                "ders adi"
        ],
        "Ogretmen": [
                "ogretmen paneli",
                "ders yonetimi",
                "sinav ekle",
                "sinav duzenle",
                "not girme",
                "not guncelle",
                "ogrenci listesi",
                "duyuru ek",
                "duyuru sil",
                "odev ek",
                "odev notla",
                "odev kriter",
                "odev grup",
                "materyal ekle",
                "materyal liste",
                "lo ekle",
                "po bagla",
                "lo bagla",
                "lo po yuzde",
                "sinav lo",
                "csv disari aktar",
                "csv ice aktar",
                "mobil not girisi",
                "qr",
                "sinav hatirlat",
                "takvim ogretmen",
                "takvim filtre",
                "ics indir",
                "ogrenci performans",
                "not bantlari",
                "ortalama not",
                "riskli ogrenci",
                "danisman ogrencilerim",
                "advisor instructor",
                "bolum paneli",
                "ders listesi",
                "ogretmen profil",
                "parola degistir",
                "profil fotograf",
                "duyuru yorum",
                "sinav detay",
                "sinav sonucu",
                "odev teslim",
                "odev gec",
                "ders materyali",
                "ders kodu",
                "ders adi",
                "cevai ogretmen",
                "yardim",
                "bildirimler"
        ],
        "Notlar": [
                "not girme",
                "not guncelle",
                "not sil",
                "skor nedir",
                "puanlama",
                "sinav sonucu",
                "sinav notu",
                "ortalama not",
                "not bantlari",
                "gecme notu",
                "csv disari aktar",
                "csv ice aktar",
                "csv format",
                "csv hata",
                "mobil not",
                "qr ile not",
                "geri bildirim",
                "not tutarsiz",
                "puan duzelt",
                "sinav notlari",
                "ogretmen not giris",
                "ogrenci not gor",
                "notlarim",
                "notlar nerede",
                "ders notu",
                "sinav ekle",
                "sinav duzenle",
                "sinav sil",
                "sinav tarihi",
                "sinav hatirlat",
                "not araligi",
                "0-100",
                "not kriter",
                "not giris ekrani",
                "not listesi",
                "not gecmis",
                "not duzeltme",
                "puanlama modeli",
                "notlama",
                "excel ile",
                "csv disari",
                "csv ice",
                "not silme",
                "bos birak",
                "kaydet",
                "sinav notu gir",
                "ogrenci notu",
                "feedback",
                "geri bildirim ek",
                "not giris hizli"
        ],
        "LO/PO": [
                "lo nedir",
                "po nedir",
                "lo ekle",
                "po ekle",
                "lo bagla",
                "po bagla",
                "lo po yuzde",
                "lo puani",
                "po puani",
                "lo po aktarim",
                "sinav lo yuzde",
                "lo kriter",
                "po kriter",
                "lo listesi",
                "po listesi",
                "lo puan hesap",
                "po puan hesap",
                "lo oran",
                "po oran",
                "lo baglantisi",
                "po baglantisi",
                "lo po harita",
                "lo po esleme",
                "program outcome",
                "learning outcome",
                "lo po graf",
                "lo po rapor",
                "lo po analiz",
                "lo po takibi",
                "lo po detay",
                "lo yuzde gir",
                "po yuzde gir",
                "lo basari",
                "po basari",
                "lo ortalama",
                "po ortalama",
                "lo notu",
                "po notu",
                "lo sinav",
                "po sinav",
                "lo po goruntule",
                "lo po sayfasi",
                "lo po tablosu",
                "lo po ayari",
                "lo po bagli",
                "lo po sil",
                "lo po guncelle",
                "lo po ekrani",
                "lo po soru",
                "lo po bilgi"
        ],
        "Odev": [
                "odev ek",
                "odev olustur",
                "odev teslim",
                "odev teslim tarihi",
                "odev gec teslim",
                "odev notla",
                "odev kriter",
                "odev rubrik",
                "odev dosya",
                "odev aciklama",
                "odev grup",
                "odev grup olustur",
                "odev kriter ekle",
                "odev puan",
                "odev geri bildirim",
                "odev listesi",
                "odev detay",
                "odev durum",
                "odev teslim et",
                "odev yeniden",
                "odev duzenle",
                "odev sil",
                "odev materyal",
                "odev ek dosya",
                "odev template",
                "odev sablon",
                "odev dosya yukle",
                "odev dosya indir",
                "odev notu",
                "odev ortalama",
                "odev kriter puan",
                "odev teslim sayisi",
                "odev eksik",
                "odev teslim kontrol",
                "odev gec",
                "odev degerlendirme",
                "odev puanlama",
                "odev feedback",
                "odev yorum",
                "odev not gir",
                "odev kriter listesi",
                "odev kriter sil",
                "odev kriter duzenle",
                "odev teslim tarihi degis",
                "odev onay",
                "odev planla",
                "odev hatirlat",
                "odev bildir",
                "odev ogrenci",
                "odev ogretmen"
        ],
        "Duyuru": [
                "duyuru ek",
                "duyuru yaz",
                "duyuru sil",
                "duyuru guncelle",
                "duyuru detayi",
                "duyuru bildirimi",
                "duyuru yorum",
                "duyuru ek dosya",
                "duyuru baslik",
                "duyuru icerik",
                "duyuru sabit",
                "duyuru pin",
                "duyuru ogrenci",
                "duyuru ogretmen",
                "duyuru tarih",
                "duyuru listesi",
                "duyuru kategori",
                "duyuru ekrani",
                "duyuru paylas",
                "duyuru gor",
                "duyuru silme",
                "duyuru duzenleme",
                "duyuru yorum ekle",
                "duyuru yorum sil",
                "duyuru yorumlari",
                "duyuru mail",
                "duyuru bildirimleri",
                "duyuru sayisi",
                "duyuru arama",
                "duyuru filtre",
                "duyuru genel",
                "duyuru ders",
                "duyuru dosya",
                "duyuru eklemek",
                "duyuru secenek",
                "duyuru duzelt",
                "duyuru hata",
                "duyuru yayin",
                "duyuru taslak",
                "duyuru onay",
                "duyuru paylasim",
                "duyuru listede",
                "duyuru goster",
                "duyuru soru",
                "duyuru cevap",
                "duyuru sorun",
                "duyuru zaman",
                "duyuru guncel",
                "duyuru eski",
                "duyuru okundu"
        ],
        "{% trans "Takvim" %}": [
                "takvim nerede",
                "takvim haftalik",
                "takvim aylik",
                "takvim gorunumu",
                "takvim filtre",
                "takvim sinav",
                "takvim ders",
                "takvim etkinlik",
                "takvim hatirlat",
                "takvim tarih",
                "takvim bugun",
                "takvim gelecek",
                "takvim gecmis",
                "takvim ics",
                "ics indir",
                "takvim paylas",
                "takvim ders filtre",
                "takvim sinav tarihi",
                "takvim saat",
                "takvim gun",
                "takvim hafta",
                "takvim ay",
                "takvim yil",
                "takvim dugme",
                "takvim liste",
                "takvim giris",
                "takvim kullan",
                "takvim sirala",
                "takvim yenile",
                "takvim iptal",
                "takvim bildirim",
                "takvim sinav hatirlat",
                "takvim ders programi",
                "takvim detay",
                "takvim acil",
                "takvim sinav ekle",
                "takvim sinav duzenle",
                "takvim ogretmen",
                "takvim ogrenci",
                "takvim bolum",
                "takvim saat dilimi",
                "takvim zaman",
                "takvim alarm",
                "takvim bugun ders",
                "takvim bos",
                "takvim sinav listesi",
                "takvim olay",
                "takvim sinav list",
                "takvim ayar",
                "takvim takibi"
        ],
        "Profil": [
                "profil guncelle",
                "profil fotograf",
                "profil email",
                "profil ad",
                "profil soyad",
                "profil sifre",
                "sifre degistir",
                "parola degistir",
                "profil gor",
                "profil duzenle",
                "profil sayfasi",
                "profil bilgiler",
                "profil kaydet",
                "profil hata",
                "profil avatar",
                "profil resim yukle",
                "profil resim sil",
                "profil foto degis",
                "profil guvenlik",
                "profil ipucu",
                "profil cikis",
                "profil oturum",
                "profil kullanici adi",
                "profil rol",
                "profil danisman",
                "profil danisman bilgisi",
                "profil eposta",
                "profil bilgisi",
                "profil duzelt",
                "profil yeni",
                "profil parola",
                "profil sifre sifirla",
                "profil sifre kural",
                "profil guncel",
                "profil hesap",
                "profil bilgi guncelle",
                "profil mail",
                "profil fotograf yukle",
                "profil fotograf sorun",
                "profil fotograf boyut",
                "profil sayfa",
                "profil ok",
                "profil degisiklik",
                "profil mesaj",
                "profil not",
                "profil ozeti",
                "profil yardim",
                "profil ayar",
                "profil tema",
                "profil guvenlik",
                "profil simge",
                "profil tamamlama",
                "profil soru",
                "profil cevap",
                "profil bilgi",
                "profil goruntule"
        ],
        "Bolum": [
                "bolum paneli",
                "bolum genel bakis",
                "bolum dersler",
                "bolum ogretmenler",
                "bolum rapor",
                "bolum analiz",
                "bolum kritik ders",
                "bolum ortalama",
                "bolum kadro",
                "bolum liste",
                "bolum ogretmen listesi",
                "bolum ders listesi",
                "bolum ders detay",
                "bolum ogretmen detay",
                "bolum not",
                "bolum sinav",
                "bolum lo",
                "bolum po",
                "bolum takip",
                "bolum istatistik",
                "bolum grafik",
                "bolum tablo",
                "bolum ozet",
                "bolum yetki",
                "bolum baskani",
                "bolum ayar",
                "bolum ogretim",
                "bolum ogrenci",
                "bolum plan",
                "bolum program",
                "bolum performans",
                "bolum risk",
                "bolum destek",
                "bolum duzenle",
                "bolum sayfa",
                "bolum sayilari",
                "bolum ders acil",
                "bolum ders kodu",
                "bolum ders adi",
                "bolum sinif",
                "bolum ogretmen atama",
                "bolum ders atama",
                "bolum takvim",
                "bolum duyuru",
                "bolum not bandi",
                "bolum islem",
                "bolum sorular",
                "bolum yardim",
                "bolum raporlama",
                "bolum paneli nedir"
        ]
};

            const faq = [
                {
                    keywords: ["giris", "login", "sifre", "parola", "oturum"],
                    answer: "Giris yapmak icin login sayfasina git. Parola unutulduysa sifre degistirme ekranini kullanabilirsin."
                },
                {
                    keywords: ["ders", "derslerim", "course", "kurs"],
                    answer: "{% trans "Dersler" %}ini {% trans "Derslerim" %} menusunden gorebilirsin. Ogrenci: <a href='/student/courses/'>{% trans "Derslerim" %}</a> | Ogretmen: <a href='/teacher/courses/'>{% trans "Derslerim" %}</a>."
                },
                {
                    keywords: ["sinav", "not", "puan", "skor"],
                    answer: "{% trans "Ogretmenler" %} 'Sinavlar & Notlar' alanindan not girer. Ogrenciler ders detayinda notlarini gorur."
                },
                {
                    keywords: ["lo", "learning outcome"],
                    answer: "LO (Learning Outcome), ders kazanimi demek. Ogretmen sinavi LO'ya yuzde ile baglar."
                },
                {
                    keywords: ["po", "programming outcome"],
                    answer: "PO (Programming Outcome) program kazanimi demek. LO puani, baglanan PO'lara yuzdeyle aktarilir."
                },
                {
                    keywords: ["lo po", "lo/po", "bagla", "baglanti", "yuzde"],
                    answer: "LO-PO baglantisi ders detayinda LO kartlarindan yapilir. Her baglanti icin yuzde girilir."
                },
                {
                    keywords: ["odev", "assignment", "teslim"],
                    answer: "Ogretmen: <a href='/teacher/assignments/'>Odevler</a>. Ogrenci: <a href='/student/assignments/'>Odevler</a>."
                },
                {
                    keywords: ["duyuru", "announcement"],
                {% trans "Duyurularim" %}
                },
                {
                    keywords: ["takvim", "calendar"],
                    answer: "{% trans "Takvim" %}: <a href='/student/calendar/'>Ogrenci takvimi</a> | <a href='/teacher/calendar/'>Ogretmen takvimi</a>."
                },
                {
                    keywords: ["profil", "hesap", "email", "eposta"],
                    answer: "Profil bilgileri icin <a href='/student/profile/'>Profil</a> sayfasini kullanabilirsin. E-posta alanlari sadece goruntulenir."
                },
                {
                    keywords: ["danisman", "advisor"],
                    answer: "Danisman bilgilerini Profil sayfasinda gorebilirsin. Danisman atanmamissa bilgi gorunmez."
                },
                {
                    keywords: ["materyal", "material"],
                    answer: "Materyaller: <a href='/student/materials/'>Ogrenci</a> | <a href='/teacher/materials/'>Ogretmen</a>."
                },
                {
                    keywords: ["bildirim", "notification"],
                    answer: "Bildirimler ust bardaki zil ikonunda gorunur. Tum bildirimler icin <a href='/notifications/'>Bildirimler</a>."
                },
                {
                    keywords: ["arama", "search"],
                    answer: "Ust bardaki arama kutusundan ders veya sinav arayabilirsin."
                },
                {
                    keywords: ["ogrenci", "student", "liste", "sinif"],
                    answer: "Ogretmen ders detayinda ogrenci listesini gorur. Ogrenciler yalniz kendi bilgilerini gorur."
                },
                {
                    keywords: ["bolum", "department", "yonetim"],
                    answer: "Bolum baskani icin {% trans "Bolum Paneli" %} menusu vardir. Ogretmen ve ders analizlerini oradan gorur."
                },
                {
                    keywords: ["csv", "disari aktar", "ice aktar"],
                    answer: "Notlar sayfasindan CSV disari aktarabilir veya CSV ice aktarabilirsin."
                },
                {
                    keywords: ["mobil", "telefon", "qr"],
                    answer: "Notlar sayfasinda QR ile mobil not girisi var. Telefon ve PC ayni agda olmali."
                },
                {
                    keywords: ["gorev", "rol", "yetki"],
                    answer: "Roluna gore menuler degisir. Rol hatasi varsa yoneticiye bildirebilirsin."
                },
                {
                    keywords: ["sifre degistir", "parola degistir"],
                    answer: "Sifre degistirmek icin Profil sayfasini kullan."
                },
                {
                    keywords: ["not ortalama", "ortalama", "analiz"],
                    answer: "Ders detayinda ogrenci ortalamalari ve basari durumlari gosterilir."
                },
                {
                    keywords: ["devamsizlik", "yoklama"],
                    answer: "Devamsizlik ozelligi yoksa yoneticiye talep olarak iletebilirsin."
                },
                {
                    keywords: ["yardim", "destek", "problem", "hata"],
                    answer: "Sorun yasarsan sayfa adini ve hatayi paylas, birlikte cozeriz."
                },
                {
                    keywords: ["dani", "danisman", "danisman hocam"],
                    answer: "Danismanini Profil sayfanda gorebilirsin. Orada ad, kullanici adi ve e-posta gorunur."
                },
                {
                    keywords: ["profil fotograf", "foto", "avatar"],
                    answer: "Profil fotografini sol menudeki profil kartindan yukleyebilirsin."
                },
                {
                    keywords: ["sinav ekle", "exam olustur"],
                    answer: "Ders detayinda Sinav Ekle butonu ile yeni sinav olusturabilirsin."
                },
                {
                    keywords: ["lo ekle", "learning outcome ekle"],
                    answer: "Ders detayinda LO Ekle butonu ile LO tanimlayabilirsin."
                },
                {
                    keywords: ["po ekle", "program outcome"],
                    answer: "PO'lar admin panelinden tanimlanir. LO kartindan PO Bagla ile yuzde girilir."
                },
                {
                    keywords: ["csv", "disa aktar", "ice aktar"],
                    answer: "Notlar sayfasinda CSV disari aktar ve CSV ice aktar kutulari vardir."
                },
                {
                    keywords: ["ogrenci notu", "sinav sonucu"],
                    answer: "Ogrenci sinav notlarini ders detayinda gorur. Ogretmen not giris ekranindan gunceller."
                },
                {
                    keywords: ["lo po puan", "po puani", "lo puani"],
                    answer: "LO puani sinav yuzdelerinden hesaplanir. PO puani LO'dan yuzdeyle aktarilir."
                },
                {
                    keywords: ["duyuru sil", "duyuru guncelle"],
                {% trans "Duyurularim" %}
                },
                {
                    keywords: ["materyal ekle", "ders materyali"],
                    answer: "{% trans "Ogretmenler" %} Materyaller sayfasindan yeni materyal ekler."
                },
                {
                    keywords: ["odev notla", "teslim", "submission"],
                {% trans "Odevler" %}
                },
                {
                    keywords: ["ogrenci listesi", "sinif listesi"],
                    answer: "Ogretmen ders detayinda ogrenci listesini gorebilir."
                },
                {
                    keywords: ["bildirimler", "okundu"],
                    answer: "Zil ikonuna tiklayip bildirimleri gorebilir ve okundu yapabilirsin."
                },
                {
                    keywords: ["takvim indirme", "ics"],
                    answer: "Ogretmen takvim sayfasinda ICS export linki var."
                },
                {
                    keywords: ["takvimde ders filtresi", "filtre"],
                    answer: "{% trans "Takvim" %} ekraninda ders filtresiyle hangi dersleri gorecegini secebilirsin."
                },
                {
                    keywords: ["sifre sifirlama", "parola sifirla"],
                    answer: "Sifre degistirme ekranindan yeni parola belirleyebilirsin."
                },
                {
                    keywords: ["ogrenci paneli", "ogrenci sayfalari"],
                {% trans "Duyurularim" %}
                },
                {
                    keywords: ["ogretmen paneli", "ogretmen sayfalari"],
                {% trans "Duyurularim" %}
                },
                {
                    keywords: ["bolum baskani", "bolum paneli"],
                    answer: "Bolum Baskani, {% trans "Bolum Paneli" %} menusuyle ogretmen ve ders analizlerini gorebilir."
                },
                {
                    keywords: ["mesaj", "yorum", "comment"],
                    answer: "Duyuru detayindan yorum ekleyebilir veya yorumlari gorebilirsin."
                },
                {
                    keywords: ["kayit", "ders kaydi"],
                    answer: "Ders kaydi icin yonetici tarafindan ogrenci derslere atanir."
                },
                {
                    keywords: ["rol degisimi", "advisor instructor"],
                    answer: "Danisman ogrenci ataninca ogretmenin rolu otomatik Advisor Instructor olur."
                },
                {
                    keywords: ["hizli erisim", "kisa yol"],
                    answer: "{% trans "Dashboard" %} uzerindeki kartlar hizli erisim saglar."
                },
                {
                    keywords: ["mobil", "qr", "telefon"],
                    answer: "Mobil not girisi icin QR okutma ozelligi notlar sayfasinda bulunur."
                },
                {
                    keywords: ["yukleme", "dosya", "ek"],
                {% trans "Odevler" %}
                },
                {
                    keywords: ["notlarim", "puanlarim"],
                    answer: "Notlarini ders detayinda gorebilirsin. Ogretmen not girince guncellenir."
                },
                {
                    keywords: ["sinav tarihi", "sinav ne zaman"],
                    answer: "Sinav tarihleri {% trans "Takvim" %}de ve ders detayinda listelenir."
                },
                {
                    keywords: ["kriter", "rubrik"],
                    answer: "Odev kriterleri ogretmen tarafindan belirlenir ve notlama oradan yapilir."
                },
                {
                    keywords: ["materyal indir", "dosya indir"],
                    answer: "Materyal detayindan veya ders detayindan dosyayi indirebilirsin."
                },
                {
                    keywords: ["oden", "odeme", "ucret"],
                    answer: "Odeme islemleri bu sistemde yok. Bu konuda ogrenci islerine basvurmalisin."
                },
                {
                    keywords: ["kapanis", "logout", "cikis"],
                    answer: "Cikis yapmak icin sol alttaki cikis ikonunu kullan."
                },
                {
                    keywords: ["hesap sil", "kapat"],
                    answer: "Hesap silme islemleri icin yoneticiyle iletisime gecmelisin."
                },
                {
                    keywords: ["profil guncelle", "bilgi guncelle"],
                    answer: "Profil sayfasindan ad/soyad degistirebilir, sifre guncelleyebilirsin."
                },
                {
                    keywords: ["bildirim kapat", "bildirim ayari"],
                    answer: "Bildirim ayarlari su an bu sistemde yok."
                },
                {
                    keywords: ["ders ekleme", "ders acma"],
                    answer: "Ders acma yetkisi yoneticidedir. {% trans "Ogretmenler" %} derslere atanir."
                },
                {
                    keywords: ["ogrenci ekle", "ogrenci ata"],
                    answer: "Ogrenciler derslere yonetici tarafindan atanir."
                },
                {
                    keywords: ["kullanici ekle", "yeni kullanici"],
                    answer: "Yeni kullanici ekleme yetkisi yoneticidedir."
                },
                {
                    keywords: ["kullanici adi degistir", "username degistir"],
                    answer: "Kullanici adi degistirme islemi yok. Yoneticiye basvur."
                },
                {
                    keywords: ["not sil", "skor sil"],
                    answer: "Notu bos birakip kaydedersen sistem eski notu siler."
                },
                {
                    keywords: ["geri bildirim", "feedback"],
                    answer: "Geri bildirimler not giris ekraninda eklenir ve ogrenci gorur."
                },
                {
                    keywords: ["ogrenci profil", "ogrenci bilgi"],
                    answer: "Ogrenciler kendi profil bilgilerini Profil sayfasindan gorur."
                },
                {
                    keywords: ["ogretmen profil", "ogretmen bilgi"],
                    answer: "{% trans "Ogretmenler" %} kendi profil bilgilerini Profil sayfasindan gunceller."
                },
                {
                    keywords: ["duyuru ek", "duyuru yaz"],
                {% trans "Duyurularim" %}
                },
                {
                    keywords: ["yorum sil", "yorum duzenle"],
                    answer: "Yorumlari duyuru detayinda gorur ve oradan yonetirsin."
                },
                {
                    keywords: ["takvim gorunumu", "aylik", "haftalik"],
                    answer: "{% trans "Takvim" %}de aylik veya haftalik gorunum secilebilir."
                },
                {
                    keywords: ["ics", "takvim indir"],
                    answer: "Ogretmen takvim ekraninda ICS baglantisi vardir."
                },
                {
                    keywords: ["ogrenci sayisi", "sinif mevcudu"],
                    answer: "Ders detayinda ogrenci sayisini gorebilirsin."
                },
                {
                    keywords: ["ortalama not", "genel ortalama"],
                    answer: "Ders detayinda ogrenci ortalamalari hesaplanir ve listelenir."
                },
                {
                    keywords: ["riskli ogrenci", "destek gerekli"],
                    answer: "Ortalama dusuk olan ogrenciler 'Destek Gerekli' olarak gosterilir."
                },
                {
                    keywords: ["ogretmen listesi", "hocalar"],
                    answer: "Bolum baskani {% trans "Bolum Paneli" %} > {% trans "Ogretmenler" %} sayfasindan gorebilir."
                },
                {
                    keywords: ["ders listesi", "tum dersler"],
                    answer: "Bolum baskani {% trans "Bolum Paneli" %} > {% trans "Dersler" %} sayfasindan tum dersleri gorebilir."
                },
                {
                    keywords: ["not bantlari", "esik"],
                    answer: "Ders detayinda not bantlari gorunur ve ogretmen duzenleyebilir."
                },
                {
                    keywords: ["lo baglama", "sinav lo"],
                    answer: "Sinav detayinda LO Bagla butonuyla LO yuzdesi girilir."
                },
                {
                    keywords: ["po baglama", "lo po"],
                    answer: "LO kartindan PO Bagla secilerek PO yuzdesi girilir."
                },
                {
                    keywords: ["rapor", "analiz"],
                    answer: "Analizler ders detayinda ve bolum panelinde goruntulenir."
                },
                {
                    keywords: ["ogrenci takibi", "danisman ogrencilerim"],
                {% trans "Danisman Ogrencilerim" %}
                },
                {
                    keywords: ["odev teslim tarihi", "gec teslim"],
                    answer: "Odev teslim tarihleri odev detayinda gorunur. Gec teslimler ayri listelenir."
                },
                {
                    keywords: ["odev ek", "odev olustur"],
                {% trans "Odevler" %}
                },
                {
                    keywords: ["duyuru bildirim", "duyuru haberi"],
                    answer: "Yeni duyurular bildirim olarak dusulur."
                },
                {
                    keywords: ["sinav hatirlatma", "hatirlat"],
                    answer: "Sinav detayinda hatirlatma gonderme ozelligi vardir."
                },
                {
                    keywords: ["dosya yukleyemiyorum", "upload hata"],
                    answer: "Dosya boyutu veya format engeli olabilir. Daha kucuk bir dosya dene."
                },
                {
                    keywords: ["sayfa acilmiyor", "yavas"],
                    answer: "Sayfa acilmiyorsa internet ve sunucu durumunu kontrol et. Devam ederse yoneticiye bildir."
                },
                {
                    keywords: ["tema", "dark mode", "koyu mod"],
                    answer: "Ust bardaki ay simgesinden tema degistirebilirsin."
                },
                {
                    keywords: ["arama kutusu", "search bar"],
                    answer: "Ust bardaki arama kutusu ile ders ve sinav arayabilirsin."
                }
            ];

            function togglePanel(forceOpen) {
                const isOpen = panel.style.display === "block";
                if (forceOpen || !isOpen) {
                    panel.style.display = "block";
                    panel.classList.remove("cevai-open");
                    void panel.offsetWidth;
                    panel.classList.add("cevai-open");
                } else {
                    panel.style.display = "none";
                    panel.classList.remove("cevai-open");
                }
            }


            function getCategoryFor(item) {
                const keys = (item.keywords || []).join(" ");
                if (item.category) return item.category;
                if (keys.indexOf("odev") !== -1) return "Odev";
                if (keys.indexOf("duyuru") !== -1 || keys.indexOf("announcement") !== -1) return "Duyuru";
                if (keys.indexOf("takvim") !== -1 || keys.indexOf("calendar") !== -1) return "{% trans "Takvim" %}";
                if (keys.indexOf("lo") !== -1 || keys.indexOf("po") !== -1) return "LO/PO";
                if (keys.indexOf("sinav") !== -1 || keys.indexOf("not") !== -1 || keys.indexOf("puan") !== -1 || keys.indexOf("csv") !== -1) return "Notlar";
                if (keys.indexOf("profil") !== -1 || keys.indexOf("sifre") !== -1 || keys.indexOf("parola") !== -1) return "Profil";
                if (keys.indexOf("bolum") !== -1) return "Bolum";
                if (keys.indexOf("ogrenci") !== -1) return "Ogrenci";
                if (keys.indexOf("ogretmen") !== -1) return "Ogretmen";
                return "Genel";
            }

            function getRolesFor(item) {
                if (item.roles) return item.roles;
                const keys = (item.keywords || []).join(" ");
                if (keys.indexOf("bolum") !== -1) return ["Head of Department"];
                if (keys.indexOf("danisman ogrencilerim") !== -1) return ["Advisor Instructor"];
                if (keys.indexOf("ogretmen paneli") !== -1 || keys.indexOf("sinav ekle") !== -1 || keys.indexOf("odev ek") !== -1 || keys.indexOf("csv") !== -1 || keys.indexOf("not gir") !== -1) {
                    return ["Regular Instructor", "Advisor Instructor", "Head of Department"];
                }
                if (keys.indexOf("ogrenci paneli") !== -1 || keys.indexOf("derslerim") !== -1) return ["Student"];
                return null;
            }

            function matchesRole(item) {
                const roles = getRolesFor(item);
                if (!roles || !roleName) return true;
                return roles.indexOf(roleName) !== -1;
            }

            function matchesPath(item) {
                if (!item.paths) return true;
                return item.paths.some(function(p) { return currentPath.indexOf(p) !== -1; });
            }

            function matchesCategory(item) {
                if (selectedCategory === "Hepsi") return true;
                return getCategoryFor(item) === selectedCategory;
            }

            function addMessage(text, who) {
                const msg = document.createElement("div");
                msg.className = "cevai-msg " + (who === "user" ? "user" : "bot");
                if (who === "bot") {
                    msg.innerHTML = text;
                } else {
                    msg.textContent = text;
                }
                body.appendChild(msg);
                body.scrollTop = body.scrollHeight;
            }

            function findAnswer(text) {
                const inputText = (text || "").toLowerCase();
                let best = null;
                let bestScore = 0;
                faq.forEach(function(item) {
                    if (!matchesRole(item) || !matchesPath(item) || !matchesCategory(item)) return;
                    let score = 0;
                    (item.keywords || []).forEach(function(k) {
                        if (inputText.indexOf(k) !== -1) score += 1;
                    });
                    if (score > bestScore) {
                        bestScore = score;
                        best = item.answer;
                    }
                });
                if (best) return best;
                // fallback without category filter
                bestScore = 0;
                faq.forEach(function(item) {
                    if (!matchesRole(item) || !matchesPath(item)) return;
                    let score = 0;
                    (item.keywords || []).forEach(function(k) {
                        if (inputText.indexOf(k) !== -1) score += 1;
                    });
                    if (score > bestScore) {
                        bestScore = score;
                        best = item.answer;
                    }                });
                return best || "Bunu tam anlayamadim. Biraz daha acik yazar misin?";
            }

            function handleSend(text) {
                const value = (text || input.value || "").trim();
                if (!value) return;
                addMessage(value, "user");
                const answer = findAnswer(value);
                setTimeout(function() { addMessage(answer, "bot"); }, 120);
                input.value = "";
            }

            if (fab) fab.addEventListener("click", function() { togglePanel(); });
            if (closeBtn) closeBtn.addEventListener("click", function() { togglePanel(false); });
            if (send) send.addEventListener("click", function() { handleSend(); });
            if (input) input.addEventListener("keydown", function(e) {
                if (e.key === "Enter") {
                    e.preventDefault();
                    handleSend();
                }
            });



            

            function renderQuickQuestions(category) {
                const container = document.getElementById("cevai-quick");
                if (!container) return;
                container.innerHTML = "";
                const key = (category || "").trim().toLowerCase();
                let matchKey = null;
                Object.keys(quickMap).forEach(function(k) {
                    if (k.toLowerCase() === key) matchKey = k;
                });
                const items = quickMap[matchKey] || quickMap["Hepsi"] || [];
                items.slice(0, 24).forEach(function(q) {
                    const answer = findAnswer(q);
                    const wrap = document.createElement("div");
                    wrap.className = "cevai-qa";
                    const qBtn = document.createElement("button");
                    qBtn.className = "cevai-qa-question";
                    qBtn.textContent = q;
                    qBtn.addEventListener("click", function() { handleSend(q); });
                    const a = document.createElement("div");
                    a.className = "cevai-qa-answer";
                    a.innerHTML = answer;
                    wrap.appendChild(qBtn);
                    wrap.appendChild(a);
                    container.appendChild(wrap);
                });
            }

            function setActiveCategory(name) {
                selectedCategory = (name || "").trim();
                renderQuickQuestions(selectedCategory);
                document.querySelectorAll(".cevai-cat").forEach(function(btn) {
                    btn.classList.toggle("active", btn.getAttribute("data-cat") === name);
                });
            }

            renderQuickQuestions("Hepsi");

            document.querySelectorAll(".cevai-cat").forEach(function(btn) {
                btn.addEventListener("click", function() {
                    setActiveCategory(btn.getAttribute("data-cat"));
                });
            });

            document.querySelectorAll(".cevai-chip").forEach(function(btn) {
                btn.addEventListener("click", function() {
                    handleSend(btn.getAttribute("data-q"));
                });
            });

        })();
    </script>
    {% endblock %}
</body>

</html>