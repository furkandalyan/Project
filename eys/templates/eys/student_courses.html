{% extends "eys/base.html" %}

{% block content %}
<div style="display:flex; flex-direction:column; gap:18px;">
    <div style="background:linear-gradient(120deg,#0f172a,#2563eb); color:white; border-radius:18px; padding:22px; box-shadow:0 22px 55px rgba(0,0,0,0.2);">
        <p style="margin:0; letter-spacing:0.08em; text-transform:uppercase; font-size:12px; opacity:0.85;">Öğrenci Paneli</p>
        <h1 style="margin:6px 0 4px 0;">Derslerim</h1>
        <p style="margin:0; opacity:0.8;">Aldığın tüm dersler, sınav ve LO özetleri tek ekranda.</p>
    </div>

    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; background:white; border-radius:14px; padding:12px; box-shadow:0 12px 32px rgba(0,0,0,0.06);">
        <input id="course-search" type="text" placeholder="Ders adı veya kodu ara..."
               style="flex:1; min-width:240px; padding:12px 14px; border-radius:10px; border:1px solid #e2e8f0;">
        <select id="course-filter-type" style="padding:12px 14px; border-radius:10px; border:1px solid #e2e8f0;">
            <option value="">Tümü</option>
            <option value="has-exam">Sınavı olanlar</option>
            <option value="has-lo">LO ekli dersler</option>
        </select>
        <a href="{% url 'student_dashboard' %}" style="padding:10px 14px; border-radius:10px; background:#f1f5f9; color:#0f172a; text-decoration:none; font-weight:600;">Dashboard</a>
        <a href="{% url 'student_calendar' %}" style="padding:10px 14px; border-radius:10px; border:1px solid #1db954; color:#1db954; text-decoration:none; font-weight:600;">Takvim</a>
    </div>

    <div class="course-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px;">
        {% for c in courses %}
        <div class="course-card"
             data-name="{{ c.name|lower }} {{ c.code|lower }}"
             data-has-exam="{{ c.exam_set.count|yesno:'1,0' }}"
             data-has-lo="{{ c.learningoutcome_set.count|yesno:'1,0' }}"
             style="background:white; border-radius:16px; padding:18px; box-shadow:0 16px 40px rgba(0,0,0,0.08); border:1px solid #eef2f7; display:flex; flex-direction:column; gap:10px;">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                <div>
                    <p style="margin:0; color:#6b7280; font-size:12px; letter-spacing:0.04em; text-transform:uppercase;">{{ c.code }}</p>
                    <h3 style="margin:6px 0 4px 0;">{{ c.name }}</h3>
                    <p style="margin:0; color:#475569; font-size:13px;">{{ c.instructor.get_full_name|default:c.instructor.username|default:"Öğretim elemanı atanmamış" }}</p>
                </div>
                <div style="text-align:right;">
                    <span style="font-size:12px; color:#94a3b8;">LO / Sınav</span>
                    <h4 style="margin:2px 0 0 0;">{{ c.learningoutcome_set.count }} / {{ c.exam_set.count }}</h4>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px;">
                <div style="background:#f8fafc; border-radius:12px; padding:10px;">
                    <p style="margin:0; font-size:12px; color:#64748b;">Sıradaki Sınav</p>
                    {% if c.next_exam_card %}
                        <strong>{{ c.next_exam_card.name }}</strong>
                        <span style="display:block; font-size:12px; color:#475569;">{{ c.next_exam_card.display_label }}</span>
                    {% else %}
                        <span style="font-size:13px; color:#94a3b8;">Planlanmadı</span>
                    {% endif %}
                </div>
                <div style="background:#f8fafc; border-radius:12px; padding:10px;">
                    <p style="margin:0; font-size:12px; color:#64748b;">Öğrenci</p>
                    <strong>{{ c.student_total }}</strong>
                </div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="course-toggle" data-target="detail-{{ c.id }}"
                        style="flex:1; border:none; border-radius:10px; padding:10px 0; background:#f1f5f9; font-weight:600; cursor:pointer;">
                    İçeriği Göster
                </button>
                <a href="{% url 'student_course_detail' c.id %}"
                   style="flex:1; text-align:center; padding:10px 0; border-radius:10px; background:#1db954; color:white; text-decoration:none; font-weight:700;">
                    Ders Sayfası →
                </a>
            </div>
            <div id="detail-{{ c.id }}" class="course-detail" style="margin-top:12px; padding:12px; border-radius:12px; background:#f8fafc; display:none;">
                <h4 style="margin:0 0 6px 0;">Learning Outcomes</h4>
                <ul style="margin:0 0 10px 0; padding-left:18px; color:#475569;">
                    {% for lo in c.learningoutcome_set.all|slice:":3" %}
                        <li>{{ lo.title }}</li>
                    {% empty %}
                        <li>Henüz LO eklenmemiş.</li>
                    {% endfor %}
                </ul>
                <h4 style="margin:0 0 6px 0;">Sınavlar</h4>
                <ul style="margin:0; padding-left:18px; color:#475569;">
                    {% for exam in c.exam_set.all|slice:":3" %}
                        <li>{{ exam.name }} — {{ exam.scheduled_at|date:"d.m.Y H:i"|default:"Tarih bekleniyor" }}</li>
                    {% empty %}
                        <li>Bu ders için sınav tanımlanmamış.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% empty %}
        <p style="color:#6b7280;">Henüz kayıtlı dersiniz bulunmuyor.</p>
        {% endfor %}
    </div>
</div>

<script>
(function() {
    const searchInput = document.getElementById("course-search");
    const filterSelect = document.getElementById("course-filter-type");
    const cards = Array.from(document.querySelectorAll(".course-card"));

    function applyFilters() {
        const query = (searchInput.value || "").toLowerCase();
        const filter = filterSelect.value;
        cards.forEach(card => {
            const matchesSearch = card.dataset.name.indexOf(query) > -1;
            let matchesFilter = true;
            if (filter === "has-exam") {
                matchesFilter = card.dataset.hasExam === "1";
            } else if (filter === "has-lo") {
                matchesFilter = card.dataset.hasLo === "1";
            }
            card.style.display = (matchesSearch && matchesFilter) ? "block" : "none";
        });
    }

    document.querySelectorAll(".course-toggle").forEach(button => {
        button.addEventListener("click", () => {
            const target = document.getElementById(button.dataset.target);
            const isHidden = target.style.display === "none" || !target.style.display;
            target.style.display = isHidden ? "block" : "none";
            button.textContent = isHidden ? "İçeriği Gizle" : "İçeriği Göster";
        });
    });

    if (searchInput) searchInput.addEventListener("input", applyFilters);
    if (filterSelect) filterSelect.addEventListener("change", applyFilters);
})();
</script>
{% endblock %}
