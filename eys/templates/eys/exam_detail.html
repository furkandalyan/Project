{% extends "eys/base.html" %}
{% load i18n %}

{% block content %}
<style>
.lo-progress-fill {
    background:#1db954;
    height:100%;
    width:0;
    transition:width 0.3s ease;
}
</style>

<div style="background:white; border-radius:20px; padding:28px; box-shadow:0 22px 55px rgba(0,0,0,0.08); margin-bottom:25px;">
    <h1 style="font-size:32px; margin:0;">{{ exam.name }}</h1>
    <p style="font-size:18px; color:#666;">{{ exam.description|default:"Açıklama bulunmuyor." }}</p>
    <p style="font-size:15px; color:#888; margin:8px 0 0 0;">
        Planlanan Tarih: {{ exam.scheduled_at|date:"d.m.Y H:i"|default:"Belirtilmedi" }} •
        Oluşturulma: {{ exam.created_at|date:"d.m.Y H:i" }}
    </p>
</div>

{% if user.role.name == 'Regular Instructor' or user.role.name == 'Advisor Instructor' or user.role.name == 'Head of Department' %}
<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; margin-bottom:30px;">
    <div style="background:white; border-radius:18px; padding:22px; box-shadow:0 18px 45px rgba(0,0,0,0.08);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <p style="margin:0; color:#9a9a9a; font-size:12px;">Not Durumu</p>
                <h2 style="margin:6px 0 0 0;">{{ graded_count }}/{{ student_total }} öğrenci</h2>
                <p style="margin:4px 0 0 0; color:#666;">Ortalama: {% if average_score %}{{ average_score|floatformat:2 }}{% else %}-{% endif %}</p>
            </div>
            <a href="{% url 'manage_exam_scores' exam.id %}"
               style="padding:10px 18px; border-radius:12px; border:1px solid #1db954; color:#1db954; text-decoration:none; font-weight:600;">
                Notları Yönet
            </a>
        </div>
        <div style="margin-top:18px; max-height:260px; overflow:auto;">
            {% if results %}
                {% for result in results %}
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #f0f0f0;">
                    <div>
                        <strong>{{ result.student.get_full_name|default:result.student.username }}</strong>
                        {% if result.feedback %}
                            <p style="margin:4px 0 0 0; color:#888; font-size:13px;">{{ result.feedback }}</p>
                        {% endif %}
                    </div>
                    <span style="font-size:18px; font-weight:700; color:#1db954;">{{ result.score }}</span>
                </div>
                {% endfor %}
            {% else %}
                <p style="margin:0; color:#999;">Henüz not girilmemiş.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if user.role.name == 'Regular Instructor' or user.role.name == 'Advisor Instructor' or user.role.name == 'Head of Department' %}
<hr style="margin:20px 0;">

<div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>Bağlı Learning Outcome'lar</h2>

    <a href="/teacher/exam/{{ exam.id }}/add-lo-weight/"
       style="background:#1db954; padding:10px 18px; color:white; border-radius:6px; text-decoration:none;">
       LO Bağla +
    </a>
</div>
{% endif %}

<div style="margin-top:20px;">
    {% for w in weights %}
    <div style="background:white; padding:18px; border-radius:12px; box-shadow:0 0 12px rgba(0,0,0,0.08); margin-bottom:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <strong>LO {{ w.learning_outcome.id }} – {{ w.learning_outcome.title }}</strong>
            <span style="color:#1db954; font-weight:600;">%{{ w.weight }}</span>
        </div>
        <div style="background:#f0f0f0; border-radius:999px; height:12px; overflow:hidden;">
            <div class="lo-progress-fill" data-progress="{{ w.weight }}"></div>
        </div>
        <p style="margin:10px 0 0 0; color:#666;">{{ w.learning_outcome.description|default:"LO açıklaması bulunmuyor." }}</p>
    </div>
    {% empty %}
    <p>Bu sınava henüz LO bağlanmamış.</p>
    {% endfor %}
</div>

<script>
(function(){
    document.querySelectorAll(".lo-progress-fill").forEach(function(el){
        var val = parseFloat(el.dataset.progress || "0");
        if (isNaN(val)) { val = 0; }
        val = Math.max(0, Math.min(100, val));
        el.style.width = val + "%";
    });
})();
</script>
{% endblock %}
